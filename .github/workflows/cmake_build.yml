name: CMake Build and Lint

on:
  push:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project:
          - simple_vm
          - binary_max_heap
          - indirect_sorting
          - arithmetic_types
          - bitset_container
          - chaining_hash_table
          - raii_temp_files
          - arithmetic_ast
          - pooled_list_allocator
          - thread_safe_multimap

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends build-essential cmake clang-tidy ninja-build

      - name: Configure CMake
        run: cmake -S pooled_list_allocator -B build_pooled_list_allocator -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build project
        run: |
          cmake --build "build_${{ matrix.project }}" -- -j$(nproc)

      - name: Run tests (ctest if available)
        run: |
          if [ -f "build_${{ matrix.project }}/CTestTestfile.cmake" ]; then
            cd "build_${{ matrix.project }}"
            ctest --output-on-failure || true
          else
            echo "No ctest configuration found for ${{ matrix.project }} — skipping ctest"
          fi

  lint:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project:
          - simple_vm
          - binary_max_heap
          - indirect_sorting
          - arithmetic_types
          - bitset_container
          - chaining_hash_table
          - raii_temp_files
          - arithmetic_ast
          - pooled_list_allocator
          - thread_safe_multimap

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends clang-tidy cmake

      - name: Configure for lint (generate compile_commands.json)
        run: |
          cmake -S "${{ matrix.project }}" -B "lint_${{ matrix.project }}" -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Run clang-tidy lint (if compile_commands.json exists)
        run: |
          if [ -f "lint_${{ matrix.project }}/compile_commands.json" ]; then
            cd "lint_${{ matrix.project }}"
            # Run clang-tidy over common C/C++ source file extensions. Limit parallelism to avoid overload.
            find "../${{ matrix.project }}" -type f \( -name '*.cpp' -o -name '*.cc' -o -name '*.cxx' -o -name '*.c' \) -print0 | \
              xargs -0 -n1 -P2 clang-tidy -p . || true
          else
            echo "compile_commands.json not found for ${{ matrix.project }} — skipping clang-tidy"
          fi
