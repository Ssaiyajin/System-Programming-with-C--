name: CMake Build and Lint

on:
  push:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CMAKE_BUILD_TYPE: Debug

jobs:
  build:
    name: Build - ${{ matrix.project }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project:
          - pooled_list_allocator
          # add other projects here as needed

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends build-essential cmake clang-tidy ninja-build

      - name: Cleanup previous build + lint directories
        run: |
          set -euo pipefail
          rm -rf "build_${{ matrix.project }}" "lint_${{ matrix.project }}" || true

      - name: Configure CMake (generate build dir + compile_commands.json)
        run: |
          set -euo pipefail
          cmake -S "${{ matrix.project }}" -B "build_${{ matrix.project }}" -G "Ninja" -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build project
        run: |
          set -euo pipefail
          cmake --build "build_${{ matrix.project }}" -- -j$(nproc)

      - name: Run tests (ctest or tester* fallback)
        run: |
          set -euo pipefail
          BUILD_DIR="build_${{ matrix.project }}"
          if [ ! -d "$BUILD_DIR" ]; then
            echo "Build directory '$BUILD_DIR' not found"
            ls -la || true
            exit 1
          fi
          cd "$BUILD_DIR"
          if command -v ctest >/dev/null 2>&1 && [ -f CTestTestfile.cmake ]; then
            ctest --output-on-failure
          else
            found=0
            while IFS= read -r -d '' exe; do
              echo "Running $exe"
              "$exe"
              found=1
            done < <(find . -type f -executable -name 'tester*' -print0)
            if [ "$found" -eq 0 ]; then
              echo "No tester* executable found in ${PWD}"
              ls -la || true
              exit 1
            fi
          fi

  lint:
    name: Lint - ${{ matrix.project }}
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project:
          - pooled_list_allocator
          # add other projects here as needed

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install lint dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends clang-tidy cmake ninja-build

      - name: Configure CMake for lint (generate compile_commands.json)
        run: |
          set -euo pipefail
          cmake -S "${{ matrix.project }}" -B "lint_${{ matrix.project }}" -G "Ninja" -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Run clang-tidy lint (if compile_commands.json exists)
        run: |
          set -euo pipefail
          LINT_DIR="lint_${{ matrix.project }}"
          if [ -f "${LINT_DIR}/compile_commands.json" ]; then
            echo "Running clang-tidy for project: ${{ matrix.project }}"
            find "${{ matrix.project }}" -type f \( -name '*.cpp' -o -name '*.cc' -o -name '*.cxx' -o -name '*.c' \) -print0 \
              | xargs -0 -n1 -P2 -I{} sh -c 'clang-tidy "{}" -p "'"${LINT_DIR}"'" || true'
          else
            echo "compile_commands.json not found for ${{ matrix.project }} â€” skipping clang-tidy"
          fi